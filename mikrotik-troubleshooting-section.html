<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solución de Problemas - Manual MikroTik</title>
    <link rel="stylesheet" href="mikrotik-styles.css">
</head>
<body>

<div class="section-content">
    <h2 id="solucion-problemas">Solución de Problemas</h2>
    
    <div class="intro-text">
        <p>En esta sección abordaremos los problemas más comunes que pueden surgir al configurar el balanceo de carga en routers MikroTik y cómo solucionarlos. Seguir estos pasos de diagnóstico le ayudará a identificar y resolver rápidamente los problemas de configuración.</p>
    </div>

    <!-- Problema 1 -->
    <div class="problem-box">
        <h3 id="problema-conexion">Problema: No hay conexión a Internet después de configurar el balanceo de carga</h3>
        
        <div class="symptoms">
            <h4>Síntomas:</h4>
            <ul>
                <li>Los dispositivos en la red local no pueden acceder a Internet</li>
                <li>El ping a direcciones externas falla</li>
                <li>Las interfaces WAN muestran conectividad física</li>
            </ul>
        </div>

        <div class="possible-causes">
            <h4>Posibles causas:</h4>
            <ul>
                <li>Configuración incorrecta de direcciones IP en las interfaces WAN</li>
                <li>Rutas por defecto mal configuradas</li>
                <li>Reglas de NAT ausentes o incorrectas</li>
                <li>Problemas con los proveedores de Internet</li>
                <li>Configuración incorrecta de las reglas de mangle (en PCC)</li>
            </ul>
        </div>

        <div class="solution">
            <h4>Solución:</h4>
            
            <ol class="numbered-steps">
                <li>
                    <strong>Verificar conectividad física:</strong>
                    <div class="code-block">
                        <pre><code>/interface print</code></pre>
                    </div>
                    <p>Compruebe que las interfaces WAN muestren "R" (running) en su estado.</p>
                </li>
                
                <li>
                    <strong>Verificar configuración de direcciones IP:</strong>
                    <div class="code-block">
                        <pre><code>/ip address print</code></pre>
                    </div>
                    <p>Confirme que cada interfaz WAN tiene la dirección IP correcta asignada.</p>
                </li>
                
                <li>
                    <strong>Comprobar conectividad con los gateways:</strong>
                    <div class="code-block">
                        <pre><code>/ping [dirección IP del gateway WAN1]
/ping [dirección IP del gateway WAN2]</code></pre>
                    </div>
                    <p>Si los pings fallan, verifique la configuración del proveedor o el cableado.</p>
                </li>
                
                <li>
                    <strong>Verificar rutas:</strong>
                    <div class="code-block">
                        <pre><code>/ip route print</code></pre>
                    </div>
                    <p>Compruebe que existen las rutas por defecto y que están activas (A).</p>
                </li>
                
                <li>
                    <strong>Verificar reglas de NAT:</strong>
                    <div class="code-block">
                        <pre><code>/ip firewall nat print</code></pre>
                    </div>
                    <p>Confirme que existen reglas de masquerade para cada interfaz WAN.</p>
                </li>
                
                <li>
                    <strong>Para PCC, verificar reglas de mangle:</strong>
                    <div class="code-block">
                        <pre><code>/ip firewall mangle print</code></pre>
                    </div>
                    <p>Compruebe que las reglas de marcado de conexiones y rutas están correctamente configuradas.</p>
                </li>
                
                <li>
                    <strong>Reiniciar servicios de red:</strong>
                    <div class="code-block">
                        <pre><code>/ip dns cache flush
/ip firewall connection remove [find]</code></pre>
                    </div>
                    <p>Esto limpiará la caché DNS y las conexiones existentes.</p>
                </li>
            </ol>
        </div>
    </div>

    <!-- Problema 2 -->
    <div class="problem-box">
        <h3 id="problema-desbalance">Problema: El tráfico no se balancea correctamente entre las conexiones</h3>
        
        <div class="symptoms">
            <h4>Síntomas:</h4>
            <ul>
                <li>Una conexión WAN muestra mucho más tráfico que la otra</li>
                <li>El rendimiento de la red no mejora después de configurar el balanceo</li>
                <li>Algunas aplicaciones funcionan lentamente a pesar del balanceo</li>
            </ul>
        </div>

        <div class="possible-causes">
            <h4>Posibles causas:</h4>
            <ul>
                <li>Configuración incorrecta del clasificador PCC</li>
                <li>Conexiones persistentes que utilizan siempre la misma ruta</li>
                <li>Diferencia significativa en la capacidad de las conexiones</li>
                <li>Algoritmo ECMP no óptimo para el tipo de tráfico</li>
            </ul>
        </div>

        <div class="solution">
            <h4>Solución:</h4>
            
            <ol class="numbered-steps">
                <li>
                    <strong>Verificar el uso actual de las interfaces:</strong>
                    <div class="code-block">
                        <pre><code>/interface monitor-traffic WAN1
/interface monitor-traffic WAN2</code></pre>
                    </div>
                    <p>Observe el tráfico en tiempo real para confirmar el desbalance.</p>
                </li>
                
                <li>
                    <strong>Para PCC, ajustar el divisor del clasificador:</strong>
                    <p>Si tiene dos conexiones de diferente capacidad, ajuste el clasificador para distribuir el tráfico proporcionalmente:</p>
                    <div class="code-block">
                        <pre><code># Para conexión WAN1 con 70% y WAN2 con 30% de capacidad
/ip firewall mangle remove [find where comment="PCC Rules"]
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN1_conn passthrough=yes in-interface=LAN per-connection-classifier=both-addresses:3/0 comment="PCC Rules"
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN1_conn passthrough=yes in-interface=LAN per-connection-classifier=both-addresses:3/1 comment="PCC Rules"
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN2_conn passthrough=yes in-interface=LAN per-connection-classifier=both-addresses:3/2 comment="PCC Rules"</code></pre>
                    </div>
                    <p>Esto asigna 2/3 del tráfico a WAN1 y 1/3 a WAN2.</p>
                </li>
                
                <li>
                    <strong>Para ECMP, ajustar el algoritmo:</strong>
                    <div class="code-block">
                        <pre><code># Cambiar al algoritmo que mejor se adapte a su tráfico
/routing ecmp set algorithm=weighted</code></pre>
                    </div>
                    <p>Pruebe diferentes algoritmos (weighted, random, round-robin) para encontrar el más adecuado.</p>
                </li>
                
                <li>
                    <strong>Verificar las conexiones activas:</strong>
                    <div class="code-block">
                        <pre><code>/ip firewall connection print where marked</code></pre>
                    </div>
                    <p>Observe cómo se están distribuyendo las conexiones entre las marcas.</p>
                </li>
                
                <li>
                    <strong>Limpiar conexiones existentes para aplicar nuevas reglas:</strong>
                    <div class="code-block">
                        <pre><code>/ip firewall connection remove [find]</code></pre>
                    </div>
                    <p>Esto forzará a que las nuevas conexiones utilicen las reglas actualizadas.</p>
                </li>
            </ol>
        </div>
    </div>

    <!-- Problema 3 -->
    <div class="problem-box">
        <h3 id="problema-failover">Problema: El failover no funciona correctamente</h3>
        
        <div class="symptoms">
            <h4>Síntomas:</h4>
            <ul>
                <li>Cuando una conexión WAN falla, no se produce la conmutación automática</li>
                <li>Pérdida de conectividad durante fallos de conexión</li>
                <li>El sistema no vuelve a la conexión principal cuando se restablece</li>
            </ul>
        </div>

        <div class="possible-causes">
            <h4>Posibles causas:</h4>
            <ul>
                <li>Falta de configuración de check-gateway en las rutas</li>
                <li>Distancias de rutas configuradas incorrectamente</li>
                <li>Problemas con el monitoreo de las conexiones</li>
                <li>Configuración incorrecta de Netwatch</li>
            </ul>
        </div>

        <div class="solution">
            <h4>Solución:</h4>
            
            <ol class="numbered-steps">
                <li>
                    <strong>Verificar configuración de rutas con check-gateway:</strong>
                    <div class="code-block">
                        <pre><code>/ip route print detail</code></pre>
                    </div>
                    <p>Confirme que las rutas tienen configurado check-gateway=ping y las distancias correctas.</p>
                </li>
                
                <li>
                    <strong>Ajustar la configuración de check-gateway:</strong>
                    <div class="code-block">
                        <pre><code>/ip route set [find gateway=203.0.113.1] check-gateway=ping scope=30 target-scope=10
/ip route set [find gateway=198.51.100.1] check-gateway=ping scope=30 target-scope=10</code></pre>
                    </div>
                    <p>Esto mejora la detección de fallos en los gateways.</p>
                </li>
                
                <li>
                    <strong>Configurar monitoreo avanzado con Netwatch:</strong>
                    <div class="code-block">
                        <pre><code>/tool netwatch
add host=8.8.8.8 interval=5s timeout=1s up-script="/ip route enable [find gateway=203.0.113.1]" down-script="/ip route disable [find gateway=203.0.113.1]"</code></pre>
                    </div>
                    <p>Esto proporciona un monitoreo más fiable que el check-gateway básico.</p>
                </li>
                
                <li>
                    <strong>Probar el failover manualmente:</strong>
                    <div class="code-block">
                        <pre><code># Deshabilitar temporalmente la ruta principal para simular un fallo
/ip route disable [find gateway=203.0.113.1]</code></pre>
                    </div>
                    <p>Verifique que el tráfico se redirige correctamente a la ruta secundaria.</p>
                </li>
                
                <li>
                    <strong>Restaurar la ruta principal:</strong>
                    <div class="code-block">
                        <pre><code>/ip route enable [find gateway=203.0.113.1]</code></pre>
                    </div>
                    <p>Verifique que el tráfico vuelve a la ruta principal.</p>
                </li>
                
                <li>
                    <strong>Ajustar tiempos de detección:</strong>
                    <div class="code-block">
                        <pre><code># Para una detección más rápida de fallos
/ip route set [find gateway=203.0.113.1] check-gateway=ping scope=30 target-scope=10 gateway-status=ping</code></pre>
                    </div>
                    <p>Esto puede reducir el tiempo de conmutación en caso de fallo.</p>
                </li>
            </ol>
        </div>
    </div>

    <!-- Problema 4 -->
    <div class="problem-box">
        <h3 id="problema-sesiones">Problema: Sesiones interrumpidas o problemas con aplicaciones específicas</h3>
        
        <div class="symptoms">
            <h4>Síntomas:</h4>
            <ul>
                <li>Las sesiones de aplicaciones (como VPN, banca en línea) se desconectan frecuentemente</li>
                <li>Algunas aplicaciones funcionan mal con el balanceo de carga</li>
                <li>Problemas con sitios web que requieren mantener la misma IP</li>
            </ul>
        </div>

        <div class="possible-causes">
            <h4>Posibles causas:</h4>
            <ul>
                <li>Cambios de ruta durante una sesión activa</li>
                <li>Aplicaciones que requieren una IP pública consistente</li>
                <li>Servicios que no funcionan bien con balanceo de conexiones</li>
                <li>Marcado incorrecto de conexiones relacionadas</li>
            </ul>
        </div>

        <div class="solution">
            <h4>Solución:</h4>
            
            <ol class="numbered-steps">
                <li>
                    <strong>Identificar aplicaciones problemáticas:</strong>
                    <p>Determine qué aplicaciones o servicios específicos están experimentando problemas.</p>
                </li>
                
                <li>
                    <strong>Crear reglas específicas para aplicaciones sensibles:</strong>
                    <div class="code-block">
                        <pre><code># Ejemplo para dirigir todo el tráfico bancario por WAN1
/ip firewall address-list add list=banking address=banco1.com
/ip firewall address-list add list=banking address=banco2.com

/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN1_conn passthrough=yes in-interface=LAN dst-address-list=banking place-before=0</code></pre>
                    </div>
                    <p>Esto asegura que ciertos servicios siempre usen la misma conexión.</p>
                </li>
                
                <li>
                    <strong>Configurar marcado de conexiones relacionadas:</strong>
                    <div class="code-block">
                        <pre><code># Asegurar que las conexiones relacionadas usen la misma ruta
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN1_conn passthrough=yes connection-mark=WAN1_conn
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN2_conn passthrough=yes connection-mark=WAN2_conn</code></pre>
                    </div>
                    <p>Esto mantiene las conexiones relacionadas en la misma ruta.</p>
                </li>
                
                <li>
                    <strong>Para servicios críticos, considerar deshabilitar el balanceo:</strong>
                    <div class="code-block">
                        <pre><code># Ejemplo para VPN o servicios financieros
/ip firewall mangle add chain=prerouting action=mark-connection new-connection-mark=WAN1_conn passthrough=yes in-interface=LAN protocol=tcp dst-port=443 place-before=0</code></pre>
                    </div>
                    <p>Esto dirige todo el tráfico HTTPS por una sola conexión, sacrificando balanceo por estabilidad.</p>
                </li>
                
                <li>
                    <strong>Ajustar el tiempo de persistencia de conexiones:</strong>
                    <div class="code-block">
                        <pre><code>/ip firewall connection tracking set tcp-established-timeout=1h udp-timeout=3m</code></pre>
                    </div>
                    <p>Esto puede ayudar a mantener las conexiones activas por más tiempo.</p>
                </li>
            </ol>
        </div>
    </div>

    <!-- Herramientas de diagnóstico -->
    <div class="diagnostic-tools">
        <h3 id="herramientas-diagnostico">Herramientas de diagnóstico útiles</h3>
        
        <p>MikroTik RouterOS ofrece varias herramientas que pueden ayudarle a diagnosticar problemas de balanceo de carga:</p>
        
        <div class="tool-box">
            <h4>Torch</h4>
            <p>Permite monitorear el tráfico en tiempo real por interfaz, dirección IP, puerto o protocolo:</p>
            <div class="code-block">
                <pre><code>/tool torch interface=WAN1 src-address=192.168.1.0/24</code></pre>
            </div>
        </div>
        
        <div class="tool-box">
            <h4>Traceroute</h4>
            <p>Muestra la ruta que toman los paquetes hacia un destino:</p>
            <div class="code-block">
                <pre><code>/tool traceroute 8.8.8.8 use-dns=yes</code></pre>
            </div>
        </div>
        
        <div class="tool-box">
            <h4>Sniffer</h4>
            <p>Captura y analiza paquetes para un diagnóstico detallado:</p>
            <div class="code-block">
                <pre><code>/tool sniffer quick ip-protocol=icmp</code></pre>
            </div>
        </div>
        
        <div class="tool-box">
            <h4>Profile</h4>
            <p>Muestra el uso de recursos del router:</p>
            <div class="code-block">
                <pre><code>/system resource cpu print
/system resource print</code></pre>
            </div>
        </div>
        
        <div class="tool-box">
            <h4>Connection</h4>
            <p>Muestra las conexiones activas y su estado:</p>
            <div class="code-block">
                <pre><code>/ip firewall connection print where marked</code></pre>
            </div>
        </div>
    </div>

    <div class="warning-box">
        <h4>Advertencia:</h4>
        <p>Antes de realizar cambios en la configuración de producción, es recomendable:</p>
        <ul>
            <li>Hacer una copia de seguridad de la configuración actual</li>
            <li>Probar los cambios en un entorno de prueba si es posible</li>
            <li>Programar una ventana de mantenimiento para implementar cambios importantes</li>
            <li>Tener un plan de reversión en caso de que los cambios causen problemas</li>
        </ul>
    </div>

</div>

</body>
</html>